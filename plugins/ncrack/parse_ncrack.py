import sqlite3

def save(datas):
    conn = sqlite3.connect("report/data.db")
    cur = conn.cursor()
    cur.execute('DROP TABLE IF EXISTS ncrack')
    cur.execute("create table ncrack (ip varchar(50), service varchar(50), user varchar(100), pass varchar(100))")
    for d in datas:
        cur.execute("insert into ncrack(ip, service, user, pass) values(?,?,?,?)", (d['ip'], d['service'], d['user'], d['pass']))
    conn.commit()
    conn.close()


def parse_hydra():
    results = []
    with open('out/ncrack/final.result') as f:
        for l in f:
            l = l.strip()
            if l.startswith("Discovered credentials on"):
                l = l.replace("Discovered credentials on", "").strip()
                print(l)
                p = l.split(" ")[0]
                print(p)
                service = p.split(":")[0]
                ip = p.split("://")[1]
                # 去除双引号
                user = l.split(" ")[1][1:-1]
                pwd = l.split(" ")[2][1:-1]
                results.append({"ip": ip, "service": service, "user": user, "pass":pwd})
    print(results)
    return results

if __name__ == "__main__":
    datas = parse_hydra()
    save(datas)
    