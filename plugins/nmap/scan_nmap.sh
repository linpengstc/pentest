cmd=$1
target=$2

masscan_bin="/Users/linpeng/pentool/masscan/bin/masscan"

scan_c(){
    echo "nmap -sP -n -iL $target  -oN  out/nmap/nmapping.ip"
    nmap -sP -n -iL $target  -oN  out/nmap/nmapping.ip

    # 取出所有存活主机，存活主机存入target.ip
    cat out/nmap/nmapping.ip | grep "Nmap scan report for"|awk {'print $5'} > out/live.ip

    rm -rf out/nmap/*.masscan
    i=0
    cat data/nmap/port.target|while read LINE;do
        portno=`echo $LINE|awk {'print $1'}`
        script=`echo $LINE|awk {'print $2'}`
        args=`echo $LINE|awk {'print $3'}`
        echo "masscan -p$portno -iL out/live.ip -oL  out/nmap/$portno.masscan"
        sudo $masscan_bin -p$portno -iL out/live.ip -oL out/nmap/$portno.masscan

        cat out/nmap/$portno.masscan |grep -v '#'|awk {'print $3'}|sort|uniq|while read PORT;do
            cat out/nmap/$portno.masscan|grep " $PORT "|awk '{print $4}' > out/nmap/$PORT.ip
            echo "nmap -A -p$PORT -n -iL out/nmap/$PORT.ip -oX out/nmap/$PORT.nmap $script $args"
            nmap -A -p$PORT -n -iL out/nmap/$PORT.ip -oX out/nmap/$PORT.nmap $script $args
        done
        ((i++));
    done
}

scan_ips(){
    nmap -p21,22,23,25,53,80-89,110,139,143,161,389,443,445,500,512,513,514,873,1080,1025,1352,1433,1521,2049,2082,2083,2181,2222,2601,2604,3128,3306,3311,3312,3389,4440,4786,4848,5000,5432,5900,5984,6082,6379,7001,7002,7778,8000,9200,9300,10000,11211,27017,27018,50000,50030,50070 -A -T4 -n -Pn -iL $target -oX out/nmap/all.nmap --script=rmi-vuln-classloader,ftp-anon,+http-title,snmp-info,ldap-novell-getpass,ldap-rootdse,ldap-search,smb-enum-*,smb-vuln-*,ms-sql-empty-password,redis-info.nse,mongodb-info
}

echo $cmd
if [ $cmd = "scan_c" ];then
    scan_c
    # echo "xxxscan_c"
elif [ $cmd = "scan_ips" ];then
    scan_ips
    echo "scan_ip"
fi