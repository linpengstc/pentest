# -*- coding: utf-8 -*-
import smtplib, re
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
import configparser
import time

class Send_Email:
    def __init__(self):
        conf = configparser.ConfigParser()
        conf.read("data/config.ini")
        self.user = conf.get("Email", "user").strip()
        self.password = conf.get("Email", "pass").strip()
        self.toemail = conf.get("Email", "target_email").strip()
        self.smtp_server = conf.get("Email", "smtp_server").strip()

    def send(self):
        msg = MIMEMultipart()
        msg["Subject"] = "漏洞报告:{}".format(str(time.strftime("%Y.%m.%d",time.localtime(time.time()))))
        msg["From"] = self.user
        msg["To"] = self.toemail
        # 本日未发现高危漏洞

        part = MIMEText("本次扫描已完成,完成时间{},扫描详情参见附件".format(str(time.strftime("%Y.%m.%d",time.localtime(time.time())))))
        msg.attach(part)

        part = MIMEApplication(open("report/report.xls", 'rb').read())
        part.add_header('Content-Disposition', 'attachment', filename="report.xls")
        msg.attach(part)
        error = 0
        while True:
            if error == 3:
                break
            try:
                s = smtplib.SMTP(self.smtp_server, timeout=30)
                s.login(self.user, self.password)
                # for toemail in self.toemails:
                #     
                s.sendmail(self.user, self.toemail.split(",") , msg.as_string())
                s.close()
                break
                
            except smtplib.SMTPException as e:
                error += 1
                print(e)
                continue

if __name__ == "__main__":
    sm = Send_Email()
    sm.send()
